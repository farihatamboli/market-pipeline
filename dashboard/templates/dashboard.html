<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MDP — Market Data Pipeline</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#07090d;--bg2:#0c1118;--bg3:#111820;--bg4:#161f2a;
  --border:#1c2b3a;--border2:#243344;
  --green:#00e5a0;--green-dim:#007a55;--green-glow:rgba(0,229,160,0.12);
  --red:#ff4060;--red-dim:rgba(255,64,96,0.12);
  --amber:#f5a623;--amber-dim:rgba(245,166,35,0.12);
  --blue:#38bdf8;--blue-dim:rgba(56,189,248,0.12);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.12);
  --text:#b8cfe0;--text-dim:#4a6580;--text-bright:#e2eef8;
  --mono:'JetBrains Mono',monospace;--ui:'Syne',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:var(--mono);font-size:12px;display:flex;flex-direction:column;}
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.025) 3px,rgba(0,0,0,0.025) 4px);pointer-events:none;z-index:9999;}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:0 20px;height:46px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0;}
.logo{font-family:var(--ui);font-weight:800;font-size:16px;color:var(--text-bright);display:flex;align-items:center;gap:8px;}
.lb{color:var(--green);}
.hdr-r{display:flex;align-items:center;gap:16px;}
.live-pill{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--text-dim);letter-spacing:.1em;}
.dot{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 6px var(--green);}50%{opacity:.3;box-shadow:none;}}
#clock{color:var(--text-dim);font-size:10px;font-variant-numeric:tabular-nums;letter-spacing:.04em;}
.src{font-size:10px;color:var(--text-dim);letter-spacing:.05em;}
.src b{color:var(--amber);}

/* MODE BAR */
.mode-bar{display:flex;align-items:center;padding:0 20px;height:36px;border-bottom:1px solid var(--border);background:var(--bg2);flex-shrink:0;gap:2px;}
.mb{font-family:var(--mono);font-size:10px;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);background:none;border:none;border-bottom:2px solid transparent;height:36px;padding:0 14px;cursor:pointer;transition:all .15s;}
.mb.active{color:var(--green);border-bottom-color:var(--green);}
.mb:hover:not(.active){color:var(--text);}
.msep{width:1px;height:18px;background:var(--border);margin:0 4px;}

/* SEARCH */
.search-wrap{margin-left:auto;position:relative;}
#si{background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:11px;padding:5px 10px 5px 26px;border-radius:3px;width:190px;outline:none;transition:border-color .15s;}
#si:focus{border-color:var(--green-dim);}
#si::placeholder{color:var(--text-dim);}
.si-icon{position:absolute;left:8px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:12px;pointer-events:none;}
#sr{position:absolute;top:calc(100% + 4px);right:0;width:270px;background:var(--bg3);border:1px solid var(--border2);border-radius:4px;z-index:500;max-height:280px;overflow-y:auto;display:none;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.sri{display:flex;justify-content:space-between;align-items:center;padding:7px 12px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .1s;}
.sri:last-child{border:none;}
.sri:hover{background:var(--bg4);}
.sri-t{font-weight:700;color:var(--text-bright);font-size:11px;}
.sri-n{color:var(--text-dim);font-size:10px;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.sri-add{font-size:9px;color:var(--green);border:1px solid var(--green-dim);padding:1px 5px;border-radius:2px;margin-left:6px;white-space:nowrap;flex-shrink:0;}

/* WATCHLIST */
.wl{display:flex;align-items:center;gap:4px;padding:0 16px;height:42px;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none;flex-shrink:0;}
.wl::-webkit-scrollbar{display:none;}
.wc{display:flex;align-items:center;gap:7px;padding:4px 10px;border-radius:3px;border:1px solid var(--border);background:var(--bg3);cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0;}
.wc:hover{border-color:var(--border2);}
.wc.active{background:var(--green-glow);border-color:var(--green);}
.wc.csel{background:var(--purple-dim);border-color:var(--purple);}
.wc-t{font-weight:700;font-size:11px;color:var(--text-bright);letter-spacing:.04em;}
.wc-p{font-size:11px;font-variant-numeric:tabular-nums;}
.wc-c{font-size:10px;}
.wc-c.up{color:var(--green);}.wc-c.dn{color:var(--red);}
.wc-x{color:var(--text-dim);font-size:9px;opacity:0;transition:opacity .1s;margin-left:2px;}
.wc:hover .wc-x{opacity:1;}

/* LAYOUT */
.main{display:flex;flex:1;overflow:hidden;}

/* LEFT */
.lp{width:240px;border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.lsec{border-bottom:1px solid var(--border);padding:10px 14px;}
.ltitle{font-family:var(--ui);font-size:9px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--text-dim);margin-bottom:8px;}
.srow{display:flex;justify-content:space-between;align-items:baseline;padding:3px 0;border-bottom:1px solid rgba(28,43,58,0.5);}
.srow:last-child{border:none;}
.sk{font-size:10px;color:var(--text-dim);}
.sv{font-size:11px;font-weight:600;color:var(--text-bright);font-variant-numeric:tabular-nums;}
.sv.g{color:var(--green);}.sv.r{color:var(--red);}.sv.a{color:var(--amber);}.sv.b{color:var(--blue);}

.ind-btn{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text-dim);font-family:var(--mono);font-size:10px;padding:5px 9px;border-radius:3px;cursor:pointer;text-align:left;margin-bottom:3px;transition:all .15s;letter-spacing:.03em;}
.ind-btn.on{background:var(--green-glow);border-color:var(--green-dim);color:var(--green);}
.ind-btn:hover:not(.on){border-color:var(--border2);color:var(--text);}

/* SIGNAL FEED */
.sf{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.sf::-webkit-scrollbar{width:3px;}
.sf::-webkit-scrollbar-thumb{background:var(--border);}
.si{padding:7px 14px;border-left:2px solid transparent;border-bottom:1px solid var(--border);animation:slid .2s ease;}
@keyframes slid{from{opacity:0;transform:translateX(-5px);}to{opacity:1;transform:none;}}
.si.PRICE_SPIKE{border-left-color:var(--red);}
.si.VOLUME_SURGE{border-left-color:var(--blue);}
.si.VOLATILITY_BURST{border-left-color:var(--amber);}
.si.VWAP_DEVIATION{border-left-color:var(--green);}
.si-top{display:flex;justify-content:space-between;margin-bottom:2px;}
.si-type{font-size:9px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;}
.PRICE_SPIKE .si-type{color:var(--red);}.VOLUME_SURGE .si-type{color:var(--blue);}.VOLATILITY_BURST .si-type{color:var(--amber);}.VWAP_DEVIATION .si-type{color:var(--green);}
.si-time{font-size:9px;color:var(--text-dim);}
.si-sym{font-size:11px;font-weight:700;color:var(--text-bright);}
.si-msg{font-size:10px;color:var(--text-dim);line-height:1.4;margin-top:2px;}
.no-si{padding:20px 14px;color:var(--text-dim);font-size:10px;text-align:center;line-height:2.2;}

/* CENTER */
.cp{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.ph{padding:12px 18px 8px;border-bottom:1px solid var(--border);display:flex;align-items:flex-end;justify-content:space-between;flex-shrink:0;}
.sym-lbl{font-family:var(--ui);font-size:10px;color:var(--text-dim);letter-spacing:.1em;margin-bottom:3px;}
.pbig{font-family:var(--ui);font-size:36px;font-weight:800;letter-spacing:-1.5px;font-variant-numeric:tabular-nums;transition:color .3s;}
.pbig.up{color:var(--green);}.pbig.dn{color:var(--red);}
.pchg{font-size:12px;font-weight:500;padding:2px 7px;border-radius:3px;margin-left:8px;}
.pchg.up{background:var(--green-glow);color:var(--green);}.pchg.dn{background:var(--red-dim);color:var(--red);}
.ctrl{display:flex;align-items:center;gap:5px;}
.cb{background:var(--bg3);border:1px solid var(--border);color:var(--text-dim);font-family:var(--mono);font-size:10px;padding:3px 8px;border-radius:3px;cursor:pointer;transition:all .15s;letter-spacing:.04em;}
.cb.active{background:var(--green-glow);border-color:var(--green-dim);color:var(--green);}
.cb:hover:not(.active){border-color:var(--border2);color:var(--text);}
.csep{width:1px;height:14px;background:var(--border);margin:0 2px;}

.ca{flex:1;display:flex;flex-direction:column;padding:10px 14px;gap:6px;overflow:hidden;}
.cbox{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:8px 11px;display:flex;flex-direction:column;}
.cbox.main{flex:1;}
.cbox.sub{height:110px;flex-shrink:0;}
.clbl{font-size:9px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-dim);margin-bottom:5px;display:flex;align-items:center;gap:8px;}
.cwrap{flex:1;position:relative;min-height:0;}

/* COMPARE GRID */
.cgrid{display:grid;grid-template-columns:1fr 1fr;gap:6px;flex:1;overflow:hidden;}
.ccard{background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:8px 11px;display:flex;flex-direction:column;}
.cc-h{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:5px;}
.cc-s{font-family:var(--ui);font-size:13px;font-weight:700;}
.cc-p{font-size:17px;font-weight:700;font-family:var(--ui);font-variant-numeric:tabular-nums;}
.cc-c{font-size:11px;margin-left:5px;}
.cc-cw{flex:1;position:relative;min-height:60px;}

/* OVERLAY */
.ov{flex:1;display:flex;flex-direction:column;padding:10px 14px;overflow:hidden;}
.ov canvas{flex:1;}
</style>
</head>
<body>

<header>
  <div class="logo"><span class="lb">[</span>MDP<span class="lb">]</span> Market Data Pipeline</div>
  <div class="hdr-r">
    <div class="src">DATA: <b id="dataSrc">DEMO</b></div>
    <div class="live-pill"><div class="dot"></div>LIVE</div>
    <div id="clock">--:--:-- UTC</div>
  </div>
</header>

<div class="mode-bar">
  <button class="mb active" onclick="setMode('single')"  id="btn-single">◈ Single</button>
  <div class="msep"></div>
  <button class="mb"        onclick="setMode('compare')" id="btn-compare">⊞ Side by Side</button>
  <div class="msep"></div>
  <button class="mb"        onclick="setMode('overlay')" id="btn-overlay">∿ Overlay %</button>
  <div class="search-wrap">
    <span class="si-icon">⌕</span>
    <input id="si" placeholder="Search 500+ stocks…" autocomplete="off" oninput="onSearch(this.value)" onblur="setTimeout(closeSearch,200)">
    <div id="sr"></div>
  </div>
</div>

<div class="wl" id="wl"></div>

<div class="main">
  <!-- LEFT PANEL -->
  <div class="lp">
    <div class="lsec">
      <div class="ltitle">Session Stats</div>
      <div class="srow"><span class="sk">OPEN</span>  <span class="sv b" id="sO">—</span></div>
      <div class="srow"><span class="sk">HIGH</span>  <span class="sv g" id="sH">—</span></div>
      <div class="srow"><span class="sk">LOW</span>   <span class="sv r" id="sL">—</span></div>
      <div class="srow"><span class="sk">VWAP</span>  <span class="sv a" id="sV">—</span></div>
      <div class="srow"><span class="sk">VOL</span>   <span class="sv"   id="sVo">—</span></div>
      <div class="srow"><span class="sk">AVG VOL</span><span class="sv" id="sAv">—</span></div>
      <div class="srow"><span class="sk">RSI</span>  <span class="sv a" id="sRsi">—</span></div>
      <div class="srow"><span class="sk">SIGNALS</span><span class="sv a" id="sSig">0</span></div>
    </div>
    <div class="lsec">
      <div class="ltitle">Indicators</div>
      <button class="ind-btn on"  onclick="toggleInd('ma')"     id="ind-ma">▸ MA 20 / MA 50</button>
      <button class="ind-btn on"  onclick="toggleInd('bb')"     id="ind-bb">▸ Bollinger Bands</button>
      <button class="ind-btn"     onclick="toggleInd('rsi')"    id="ind-rsi">▸ RSI (14)</button>
      <button class="ind-btn"     onclick="toggleInd('candle')" id="ind-candle">▸ Candlestick View</button>
    </div>
    <div style="padding:8px 14px 4px;flex-shrink:0">
      <div class="ltitle">Signal Feed <span id="scnt" style="font-weight:400;color:var(--text-dim)">(0)</span></div>
    </div>
    <div class="sf" id="sf"><div class="no-si">░ Monitoring…<br><small>Signals appear live</small></div></div>
  </div>

  <!-- CENTER -->
  <div class="cp">
    <div class="ph">
      <div>
        <div class="sym-lbl" id="symLbl">AAPL</div>
        <div style="display:flex;align-items:baseline">
          <div class="pbig up" id="pbig">—</div>
          <div class="pchg up" id="pchg">—</div>
        </div>
      </div>
      <div class="ctrl">
        <button class="cb active" onclick="setRange(30)"  id="r30">30</button>
        <button class="cb"        onclick="setRange(60)"  id="r60">60</button>
        <button class="cb"        onclick="setRange(120)" id="r120">120</button>
      </div>
    </div>

    <!-- SINGLE MODE -->
    <div class="ca" id="mSingle">
      <div class="cbox main">
        <div class="clbl">
          <span>PRICE</span>
          <span style="color:var(--green)">─ Price</span>
          <span style="color:var(--amber)">╌ VWAP</span>
          <span style="color:var(--blue)"  id="lgMA">─ MA20 ─ MA50</span>
          <span style="color:rgba(167,139,250,.6)" id="lgBB">░ BB</span>
        </div>
        <div class="cwrap"><canvas id="mainC"></canvas></div>
      </div>
      <div class="cbox sub" id="rsiBox" style="display:none">
        <div class="clbl">RSI (14)
          <span style="color:var(--red);font-size:9px">── 70</span>
          <span style="color:var(--text-dim);font-size:9px">── 50</span>
          <span style="color:var(--green);font-size:9px">── 30</span>
        </div>
        <div class="cwrap"><canvas id="rsiC"></canvas></div>
      </div>
      <div class="cbox sub">
        <div class="clbl">VOLUME</div>
        <div class="cwrap"><canvas id="volC"></canvas></div>
      </div>
    </div>

    <!-- COMPARE (side by side) -->
    <div class="ca" id="mCompare" style="display:none">
      <div class="cgrid" id="cgrid"></div>
    </div>

    <!-- OVERLAY -->
    <div class="ov" id="mOverlay" style="display:none">
      <div class="clbl" id="ovLbl" style="margin-bottom:8px">Normalised % from open — click chips to select</div>
      <div class="cwrap" style="flex:1"><canvas id="ovC"></canvas></div>
    </div>
  </div>
</div>

<script>
// ── S&P 500 ───────────────────────────────────────────────────────────────────
const SP500=[["MMM","3M"],["ABBV","AbbVie"],["ACN","Accenture"],["ADBE","Adobe"],["AMD","AMD"],["GOOGL","Alphabet A"],["GOOG","Alphabet C"],["MO","Altria"],["AMZN","Amazon"],["AXP","American Express"],["AMT","American Tower"],["AMGN","Amgen"],["APH","Amphenol"],["ADI","Analog Devices"],["AON","Aon"],["AAPL","Apple"],["AMAT","Applied Materials"],["ANET","Arista Networks"],["T","AT&T"],["ADSK","Autodesk"],["ADP","ADP"],["AZO","AutoZone"],["BAC","Bank of America"],["BDX","Becton Dickinson"],["BRK.B","Berkshire B"],["BIIB","Biogen"],["BLK","BlackRock"],["BX","Blackstone"],["BA","Boeing"],["BSX","Boston Scientific"],["BMY","Bristol-Myers"],["AVGO","Broadcom"],["CAT","Caterpillar"],["CVX","Chevron"],["CMG","Chipotle"],["CB","Chubb"],["CI","Cigna"],["CTAS","Cintas"],["CSCO","Cisco"],["C","Citigroup"],["CLX","Clorox"],["CME","CME Group"],["KO","Coca-Cola"],["CTSH","Cognizant"],["CL","Colgate-Palmolive"],["CMCSA","Comcast"],["COP","ConocoPhillips"],["STZ","Constellation Brands"],["COST","Costco"],["CCI","Crown Castle"],["CSX","CSX"],["CVS","CVS Health"],["DHR","Danaher"],["DE","Deere"],["DAL","Delta Air"],["DXCM","DexCom"],["DLR","Digital Realty"],["DFS","Discover"],["DG","Dollar General"],["DLTR","Dollar Tree"],["D","Dominion Energy"],["DPZ","Domino's"],["DOW","Dow"],["DHI","D.R. Horton"],["DUK","Duke Energy"],["EBAY","eBay"],["ECL","Ecolab"],["EW","Edwards Lifesciences"],["EA","Electronic Arts"],["ELV","Elevance Health"],["EMR","Emerson Electric"],["EOG","EOG Resources"],["EFX","Equifax"],["EQIX","Equinix"],["EL","Estee Lauder"],["ETSY","Etsy"],["EXC","Exelon"],["XOM","Exxon Mobil"],["FAST","Fastenal"],["FDX","FedEx"],["FIS","FIS"],["FITB","Fifth Third"],["FSLR","First Solar"],["FI","Fiserv"],["F","Ford"],["FTNT","Fortinet"],["FCX","Freeport-McMoRan"],["GE","GE Aerospace"],["GD","General Dynamics"],["GIS","General Mills"],["GM","General Motors"],["GILD","Gilead"],["GS","Goldman Sachs"],["HAL","Halliburton"],["HCA","HCA Healthcare"],["HLT","Hilton"],["HD","Home Depot"],["HON","Honeywell"],["HPQ","HP Inc"],["HUM","Humana"],["IBM","IBM"],["IDXX","Idexx Labs"],["ITW","Illinois Tool"],["INTC","Intel"],["ICE","ICE"],["INTU","Intuit"],["ISRG","Intuitive Surgical"],["IQV","IQVIA"],["IRM","Iron Mountain"],["JNJ","Johnson & Johnson"],["JCI","Johnson Controls"],["JPM","JPMorgan"],["KEY","KeyCorp"],["KLAC","KLA Corp"],["KHC","Kraft Heinz"],["KR","Kroger"],["LHX","L3Harris"],["LRCX","Lam Research"],["LVS","Las Vegas Sands"],["LEN","Lennar"],["LLY","Eli Lilly"],["LIN","Linde"],["LMT","Lockheed Martin"],["LOW","Lowe's"],["LULU","Lululemon"],["MA","Mastercard"],["MCD","McDonald's"],["MCK","McKesson"],["MDT","Medtronic"],["MRK","Merck"],["META","Meta"],["MET","MetLife"],["MU","Micron"],["MSFT","Microsoft"],["MRNA","Moderna"],["MDLZ","Mondelez"],["MNST","Monster Beverage"],["MCO","Moody's"],["MS","Morgan Stanley"],["MSI","Motorola Solutions"],["NFLX","Netflix"],["NEM","Newmont"],["NEE","NextEra Energy"],["NKE","Nike"],["NSC","Norfolk Southern"],["NOC","Northrop Grumman"],["NUE","Nucor"],["NVDA","Nvidia"],["NXPI","NXP Semi"],["ORLY","O'Reilly Auto"],["OXY","Occidental"],["ORCL","Oracle"],["PCAR","Paccar"],["PANW","Palo Alto Networks"],["PH","Parker Hannifin"],["PAYX","Paychex"],["PYPL","PayPal"],["PEP","PepsiCo"],["PFE","Pfizer"],["PM","Philip Morris"],["PSX","Phillips 66"],["PNC","PNC Financial"],["PG","Procter & Gamble"],["PGR","Progressive"],["PLD","Prologis"],["PRU","Prudential"],["QCOM","Qualcomm"],["RTX","RTX"],["O","Realty Income"],["REGN","Regeneron"],["RSG","Republic Services"],["RMD","ResMed"],["ROP","Roper Tech"],["ROST","Ross Stores"],["RCL","Royal Caribbean"],["SPGI","S&P Global"],["CRM","Salesforce"],["SLB","Schlumberger"],["NOW","ServiceNow"],["SHW","Sherwin-Williams"],["SPG","Simon Property"],["SO","Southern Co"],["LUV","Southwest Air"],["SBUX","Starbucks"],["STT","State Street"],["STLD","Steel Dynamics"],["SYK","Stryker"],["SYF","Synchrony"],["SNPS","Synopsys"],["SYY","Sysco"],["TMUS","T-Mobile"],["TGT","Target"],["TSLA","Tesla"],["TXN","Texas Instruments"],["TMO","Thermo Fisher"],["TJX","TJX"],["TSCO","Tractor Supply"],["TT","Trane Tech"],["TDG","TransDigm"],["TRV","Travelers"],["TFC","Truist"],["TSN","Tyson Foods"],["USB","US Bancorp"],["UBER","Uber"],["UNP","Union Pacific"],["UAL","United Airlines"],["UPS","UPS"],["URI","United Rentals"],["UNH","UnitedHealth"],["VLO","Valero"],["VRSN","VeriSign"],["VRSK","Verisk"],["VZ","Verizon"],["VRTX","Vertex"],["VICI","VICI Props"],["V","Visa"],["VMC","Vulcan Materials"],["WBA","Walgreens"],["WMT","Walmart"],["DIS","Walt Disney"],["WFC","Wells Fargo"],["WELL","Welltower"],["WDC","Western Digital"],["WMB","Williams Cos"],["WYNN","Wynn"],["XEL","Xcel Energy"],["YUM","Yum! Brands"],["ZBH","Zimmer Biomet"],["ZTS","Zoetis"],["SPY","S&P 500 ETF"],["QQQ","Nasdaq ETF"],["IWM","Russell 2000 ETF"],["DIA","Dow Jones ETF"],["GLD","Gold ETF"],["TLT","20yr Treasury ETF"],["VNQ","Real Estate ETF"],["ARKK","ARK Innovation ETF"],["XLK","Tech Sector ETF"],["XLF","Financial Sector ETF"],["XLE","Energy Sector ETF"],["XLV","Healthcare ETF"],["XBI","Biotech ETF"]];

// ── STATE ─────────────────────────────────────────────────────────────────────
let wl         = ['AAPL','MSFT','NVDA','TSLA','SPY','META','GOOGL','AMZN'];
let active     = 'AAPL';
let cmpSyms    = [];
let mode       = 'single';
let rng        = 60;
let inds       = {ma:true,bb:true,rsi:false,candle:false};
let opens      = {};
let cache      = {};
let sigCnt     = 0, knownSigs = 0;

let mainCh=null,rsiCh=null,volCh=null,ovCh=null;
const cmpChs={};
const COLORS=['#00e5a0','#38bdf8','#f5a623','#a78bfa','#ff4060','#fb923c'];

// ── CLOCK ─────────────────────────────────────────────────────────────────────
setInterval(()=>{
  const n=new Date();
  document.getElementById('clock').textContent=
    [n.getUTCHours(),n.getUTCMinutes(),n.getUTCSeconds()].map(x=>String(x).padStart(2,'0')).join(':') + ' UTC';
},1000);

// ── MATH ──────────────────────────────────────────────────────────────────────
const fmt  = n => n!=null?n.toFixed(2):'—';
const fmtV = n => n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(0)+'K':String(n??0);

function ma(arr,p){return arr.map((_,i)=>i<p-1?null:arr.slice(i-p+1,i+1).reduce((a,b)=>a+b,0)/p);}

function bb(arr,p=20,s=2){
  const u=[],l=[],m=[];
  arr.forEach((_,i)=>{
    if(i<p-1){u.push(null);l.push(null);m.push(null);return;}
    const sl=arr.slice(i-p+1,i+1),mn=sl.reduce((a,b)=>a+b,0)/p;
    const sd=Math.sqrt(sl.reduce((a,b)=>a+(b-mn)**2,0)/p);
    m.push(mn);u.push(mn+s*sd);l.push(mn-s*sd);
  });
  return{u,l,m};
}

function rsi(arr,p=14){
  return arr.map((_,i)=>{
    if(i<p)return null;
    const ch=arr.slice(i-p,i).map((v,j)=>arr[i-p+j+1]-v);
    const g=ch.filter(c=>c>0).reduce((a,b)=>a+b,0)/p;
    const ls=Math.abs(ch.filter(c=>c<0).reduce((a,b)=>a+b,0))/p;
    return ls===0?100:100-100/(1+g/ls);
  });
}

function hexA(h,a){const r=parseInt(h.slice(1,3),16),g=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16);return`rgba(${r},${g},${b},${a})`;}

// ── BASE CHART OPTIONS ────────────────────────────────────────────────────────
const BOPTS={
  responsive:true,maintainAspectRatio:false,animation:{duration:250},
  plugins:{legend:{display:false},tooltip:{backgroundColor:'#0c1118',borderColor:'#1c2b3a',borderWidth:1,titleColor:'#b8cfe0',bodyColor:'#4a6580',padding:8,titleFont:{family:'JetBrains Mono',size:10},bodyFont:{family:'JetBrains Mono',size:10}}},
  scales:{
    x:{grid:{color:'#1c2b3a'},ticks:{color:'#4a6580',font:{family:'JetBrains Mono',size:9},maxTicksLimit:8}},
    y:{grid:{color:'#1c2b3a'},ticks:{color:'#4a6580',font:{family:'JetBrains Mono',size:9},maxTicksLimit:6},position:'right'},
  }
};

// ── INIT CHARTS ───────────────────────────────────────────────────────────────
function initMain(){
  if(mainCh)mainCh.destroy();
  mainCh=new Chart(document.getElementById('mainC').getContext('2d'),{
    type:'line',
    data:{labels:[],datasets:[
      {label:'Price', data:[],borderColor:'#00e5a0',borderWidth:2,pointRadius:0,tension:0.25,fill:true,
        backgroundColor:ctx=>{const g=ctx.chart.ctx.createLinearGradient(0,0,0,180);g.addColorStop(0,'rgba(0,229,160,0.14)');g.addColorStop(1,'rgba(0,229,160,0)');return g;}},
      {label:'VWAP',   data:[],borderColor:'#f5a623',borderWidth:1,borderDash:[3,3],pointRadius:0,tension:0.25,fill:false},
      {label:'MA20',   data:[],borderColor:'#38bdf8',borderWidth:1,pointRadius:0,tension:0.25,fill:false},
      {label:'MA50',   data:[],borderColor:'#a78bfa',borderWidth:1,pointRadius:0,tension:0.25,fill:false},
      {label:'BB Up',  data:[],borderColor:'rgba(167,139,250,0.4)',borderWidth:1,borderDash:[2,2],pointRadius:0,tension:0.25,fill:false},
      {label:'BB Lo',  data:[],borderColor:'rgba(167,139,250,0.4)',borderWidth:1,borderDash:[2,2],pointRadius:0,tension:0.25,fill:'4',backgroundColor:'rgba(167,139,250,0.05)'},
    ]},
    options:{...BOPTS}
  });
}

function initRsi(){
  if(rsiCh)rsiCh.destroy();
  rsiCh=new Chart(document.getElementById('rsiC').getContext('2d'),{
    type:'line',
    data:{labels:[],datasets:[
      {label:'RSI',data:[],borderColor:'#f5a623',borderWidth:1.5,pointRadius:0,tension:0.25,fill:false},
      {label:'70', data:[],borderColor:'rgba(255,64,96,0.4)',borderWidth:1,borderDash:[4,2],pointRadius:0,fill:false},
      {label:'30', data:[],borderColor:'rgba(0,229,160,0.4)',borderWidth:1,borderDash:[4,2],pointRadius:0,fill:false},
      {label:'50', data:[],borderColor:'rgba(255,255,255,0.08)',borderWidth:1,borderDash:[2,4],pointRadius:0,fill:false},
    ]},
    options:{...BOPTS,scales:{...BOPTS.scales,y:{...BOPTS.scales.y,min:0,max:100}}}
  });
}

function initVol(){
  if(volCh)volCh.destroy();
  volCh=new Chart(document.getElementById('volC').getContext('2d'),{
    type:'bar',
    data:{labels:[],datasets:[{label:'Vol',data:[],backgroundColor:'rgba(56,189,248,0.22)',borderColor:'#38bdf8',borderWidth:1,borderRadius:2}]},
    options:{...BOPTS,scales:{...BOPTS.scales,y:{...BOPTS.scales.y,ticks:{...BOPTS.scales.y.ticks,callback:v=>fmtV(v)}}}}
  });
}

function initOverlay(){
  if(ovCh)ovCh.destroy();
  ovCh=new Chart(document.getElementById('ovC').getContext('2d'),{
    type:'line',data:{labels:[],datasets:[]},
    options:{...BOPTS,
      plugins:{...BOPTS.plugins,legend:{display:true,labels:{color:'#b8cfe0',font:{family:'JetBrains Mono',size:10},boxWidth:18,padding:12}}},
      scales:{...BOPTS.scales,y:{...BOPTS.scales.y,ticks:{...BOPTS.scales.y.ticks,callback:v=>`${v>0?'+':''}${v?.toFixed(1)}%`}}}
    }
  });
}

// ── RENDER SINGLE ─────────────────────────────────────────────────────────────
function renderSingle(ticks){
  const t=ticks.slice(-rng);
  if(!t.length)return;
  const labels=t.map(x=>x.ts.slice(11,16));
  const prices=t.map(x=>x.price);
  const vwaps =t.map(x=>x.vwap);
  const vols  =t.map(x=>x.volume);
  const ma20  =ma(prices,20);
  const ma50  =ma(prices,50);
  const bbs   =bb(prices);
  const rsiV  =rsi(prices);
  const lastRsi=rsiV.filter(v=>v!=null).pop();

  mainCh.data.labels=labels;
  mainCh.data.datasets[0].data=prices;
  mainCh.data.datasets[1].data=vwaps;
  mainCh.data.datasets[2].data=inds.ma?ma20:[];
  mainCh.data.datasets[3].data=inds.ma?ma50:[];
  mainCh.data.datasets[4].data=inds.bb?bbs.u:[];
  mainCh.data.datasets[5].data=inds.bb?bbs.l:[];
  mainCh.update('none');

  if(rsiCh&&inds.rsi){
    rsiCh.data.labels=labels;
    rsiCh.data.datasets[0].data=rsiV;
    rsiCh.data.datasets[1].data=labels.map(()=>70);
    rsiCh.data.datasets[2].data=labels.map(()=>30);
    rsiCh.data.datasets[3].data=labels.map(()=>50);
    rsiCh.update('none');
  }

  volCh.data.labels=labels;
  volCh.data.datasets[0].data=vols;
  volCh.update('none');

  // Price header
  const last=t[t.length-1],prev=t[t.length-2];
  const op=opens[active]??prices[0];
  const el=document.getElementById('pbig');
  el.textContent=fmt(last.price);
  el.className='pbig '+(last.price>=(prev?.price??last.price)?'up':'dn');
  const da=last.price-op,dp=op?(da/op*100):0,sg=da>=0?'+':'';
  const ce=document.getElementById('pchg');
  ce.textContent=`${sg}${fmt(da)} (${sg}${dp.toFixed(2)}%)`;
  ce.className='pchg '+(da>=0?'up':'dn');
  document.getElementById('symLbl').textContent=active;

  // Left stats
  document.getElementById('sO').textContent  =fmt(op);
  document.getElementById('sH').textContent  =fmt(Math.max(...prices));
  document.getElementById('sL').textContent  =fmt(Math.min(...prices));
  document.getElementById('sV').textContent  =fmt(last.vwap);
  document.getElementById('sVo').textContent =fmtV(last.volume);
  const av=vols.reduce((a,b)=>a+b,0)/vols.length;
  document.getElementById('sAv').textContent =fmtV(Math.round(av));
  document.getElementById('sRsi').textContent=lastRsi?lastRsi.toFixed(1):'—';
}

// ── RENDER COMPARE ────────────────────────────────────────────────────────────
async function renderCompare(){
  const syms=cmpSyms.length>=2?cmpSyms:[active,...wl.filter(s=>s!==active).slice(0,3)];
  const grid=document.getElementById('cgrid');
  grid.innerHTML='';
  for(let i=0;i<Math.min(syms.length,4);i++){
    const sym=syms[i],col=COLORS[i];
    const ticks=(cache[sym]||await fetchTicks(sym)).slice(-rng);
    if(!ticks.length)continue;
    const prices=ticks.map(x=>x.price),last=ticks[ticks.length-1];
    const op=opens[sym]??prices[0],da=last.price-op,dp=op?(da/op*100):0;
    const isUp=da>=0;
    const card=document.createElement('div');
    card.className='ccard';
    card.innerHTML=`<div class="cc-h"><span class="cc-s" style="color:${col}">${sym}</span><div><span class="cc-p" style="color:${isUp?'var(--green)':'var(--red)'}">${fmt(last.price)}</span><span class="cc-c" style="color:${isUp?'var(--green)':'var(--red)'}">${isUp?'+':''}${dp.toFixed(2)}%</span></div></div><div class="cc-cw"><canvas id="cc_${sym}"></canvas></div>`;
    grid.appendChild(card);
    setTimeout(()=>{
      const ctx=document.getElementById(`cc_${sym}`)?.getContext('2d');
      if(!ctx)return;
      if(cmpChs[sym])cmpChs[sym].destroy();
      cmpChs[sym]=new Chart(ctx,{type:'line',data:{labels:ticks.map(x=>x.ts.slice(11,16)),datasets:[
        {data:prices,borderColor:col,borderWidth:1.5,pointRadius:0,tension:0.2,fill:true,backgroundColor:hexA(col,0.1)},
        {data:ma(prices,20),borderColor:hexA(col,0.45),borderWidth:1,borderDash:[3,2],pointRadius:0,tension:0.2,fill:false},
      ]},options:{...BOPTS,animation:{duration:0}}});
    },10);
  }
}

// ── RENDER OVERLAY ────────────────────────────────────────────────────────────
async function renderOverlay(){
  const syms=cmpSyms.length>=2?cmpSyms:[active,...wl.filter(s=>s!==active).slice(0,4)];
  const labels=[];const datasets=[];
  for(let i=0;i<Math.min(syms.length,6);i++){
    const sym=syms[i],col=COLORS[i];
    const ticks=(cache[sym]||await fetchTicks(sym)).slice(-rng);
    if(!ticks.length)continue;
    const prices=ticks.map(x=>x.price),base=prices[0]||1;
    const normed=prices.map(p=>(p-base)/base*100);
    if(!labels.length)ticks.forEach(x=>labels.push(x.ts.slice(11,16)));
    datasets.push({label:sym,data:normed,borderColor:col,borderWidth:1.5,pointRadius:0,tension:0.2,fill:false});
  }
  ovCh.data.labels=labels;ovCh.data.datasets=datasets;ovCh.update('none');
}

// ── FETCH ─────────────────────────────────────────────────────────────────────
async function fetchTicks(sym){
  try{
    const r=await fetch(`/api/ticks/${sym}?limit=120`);
    const t=await r.json();
    cache[sym]=t;
    if(!opens[sym]&&t.length)opens[sym]=t[0].price;
    return t;
  }catch(e){return[];}
}

async function pollAll(){
  const ticks=await fetchTicks(active);
  // refresh watchlist chips
  for(const sym of wl){const t=cache[sym];if(t&&t.length)updateChip(sym,t[t.length-1]);}
  if(mode==='single')renderSingle(ticks);
  else if(mode==='compare')renderCompare();
  else renderOverlay();
}

async function pollSigs(){
  try{
    const r=await fetch('/api/signals');const sigs=await r.json();
    if(sigs.length>knownSigs){sigs.slice(knownSigs).forEach(addSig);knownSigs=sigs.length;}
  }catch(e){}
}

async function pollStatus(){
  try{const r=await fetch(`/api/status?symbol=${active}`);const d=await r.json();document.getElementById('dataSrc').textContent=d.source.toUpperCase();}catch(e){}
}

// ── WATCHLIST ─────────────────────────────────────────────────────────────────
function buildWL(){
  const bar=document.getElementById('wl');bar.innerHTML='';
  wl.forEach(sym=>{
    const c=document.createElement('div');
    c.className='wc'+(sym===active&&mode==='single'?' active':'')+(cmpSyms.includes(sym)?' csel':'');
    c.id=`wc_${sym}`;
    c.innerHTML=`<span class="wc-t">${sym}</span><span class="wc-p" id="wp_${sym}">—</span><span class="wc-c" id="wc_${sym}"></span><span class="wc-x" onclick="rmWL('${sym}',event)">✕</span>`;
    c.onclick=e=>{if(e.target.classList.contains('wc-x'))return;selSym(sym);};
    bar.appendChild(c);
    fetchTicks(sym);
  });
}

function updateChip(sym,tick){
  const pe=document.getElementById(`wp_${sym}`),ce=document.getElementById(`wc_${sym}`);
  if(!pe)return;
  pe.textContent=fmt(tick.price);
  const op=opens[sym]??tick.price,chg=(tick.price-op)/op*100;
  ce.textContent=`${chg>=0?'+':''}${chg.toFixed(2)}%`;
  ce.className='wc-c '+(chg>=0?'up':'dn');
}

function selSym(sym){
  if(mode==='single'){
    active=sym;
    document.querySelectorAll('.wc').forEach(c=>c.classList.remove('active'));
    document.getElementById(`wc_${sym}`)?.classList.add('active');
    pollAll();
  }else{
    if(cmpSyms.includes(sym))cmpSyms=cmpSyms.filter(s=>s!==sym);
    else if(cmpSyms.length<6)cmpSyms.push(sym);
    document.querySelectorAll('.wc').forEach(c=>c.classList.remove('csel'));
    cmpSyms.forEach(s=>document.getElementById(`wc_${s}`)?.classList.add('csel'));
    pollAll();
  }
}

function rmWL(sym,e){
  e.stopPropagation();
  wl=wl.filter(s=>s!==sym);
  cmpSyms=cmpSyms.filter(s=>s!==sym);
  if(active===sym)active=wl[0]||'AAPL';
  buildWL();
}

function addToWL(sym){
  if(!wl.includes(sym)){wl.push(sym);buildWL();}
  closeSearch();document.getElementById('si').value='';
}

// ── SEARCH ────────────────────────────────────────────────────────────────────
function onSearch(q){
  const box=document.getElementById('sr');
  if(!q){box.style.display='none';return;}
  const ql=q.toLowerCase();
  const hits=SP500.filter(([t,n])=>t.toLowerCase().startsWith(ql)||n.toLowerCase().includes(ql)).slice(0,8);
  if(!hits.length){box.style.display='none';return;}
  box.innerHTML=hits.map(([t,n])=>`<div class="sri" onclick="addToWL('${t}')"><span class="sri-t">${t}</span><span class="sri-n">${n}<span class="sri-add">+ ADD</span></span></div>`).join('');
  box.style.display='block';
}
function closeSearch(){document.getElementById('sr').style.display='none';}

// ── MODE ──────────────────────────────────────────────────────────────────────
function setMode(m){
  mode=m;cmpSyms=[];
  document.querySelectorAll('.mb').forEach(b=>b.classList.remove('active'));
  document.getElementById(`btn-${m}`)?.classList.add('active');
  document.getElementById('mSingle').style.display  =m==='single'?'flex':'none';
  document.getElementById('mCompare').style.display =m==='compare'?'flex':'none';
  document.getElementById('mOverlay').style.display =m==='overlay'?'flex':'none';
  document.querySelectorAll('.wc').forEach(c=>{c.classList.remove('csel','active');});
  if(m==='single')document.getElementById(`wc_${active}`)?.classList.add('active');
  if(m==='overlay'&&!ovCh)initOverlay();
  pollAll();
}

// ── RANGE ─────────────────────────────────────────────────────────────────────
function setRange(n){
  rng=n;
  ['r30','r60','r120'].forEach(id=>document.getElementById(id)?.classList.remove('active'));
  document.getElementById(`r${n}`)?.classList.add('active');
  pollAll();
}

// ── INDICATORS ────────────────────────────────────────────────────────────────
function toggleInd(k){
  inds[k]=!inds[k];
  document.getElementById(`ind-${k}`)?.classList.toggle('on',inds[k]);
  if(k==='rsi'){
    document.getElementById('rsiBox').style.display=inds.rsi?'flex':'none';
    if(inds.rsi&&!rsiCh)initRsi();
  }
  pollAll();
}

// ── SIGNALS ───────────────────────────────────────────────────────────────────
const ICONS={PRICE_SPIKE:'▲',VOLUME_SURGE:'◉',VOLATILITY_BURST:'⚡',VWAP_DEVIATION:'◈'};
function addSig(sig){
  sigCnt++;
  document.getElementById('sSig').textContent=sigCnt;
  document.getElementById('scnt').textContent=`(${sigCnt})`;
  const feed=document.getElementById('sf');
  feed.querySelector('.no-si')?.remove();
  const el=document.createElement('div');
  el.className=`si ${sig.type}`;
  el.innerHTML=`<div class="si-top"><span class="si-type">${ICONS[sig.type]||'◆'} ${(sig.type||'').replace(/_/g,' ')}</span><span class="si-time">${(sig.ts||'').slice(11,19)}</span></div><div class="si-sym">${sig.symbol}</div><div class="si-msg">${sig.message}</div>`;
  feed.insertBefore(el,feed.firstChild);
  while(feed.children.length>40)feed.removeChild(feed.lastChild);
}

// ── INIT ──────────────────────────────────────────────────────────────────────
(async()=>{
  initMain();initVol();buildWL();
  await pollAll();
  setInterval(pollAll,  5000);
  setInterval(pollSigs, 5000);
  setInterval(pollStatus,15000);
  pollStatus();
})();
</script>
</body>
</html>
